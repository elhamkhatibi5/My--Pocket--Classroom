
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pocket Classroom â€” Offline (single file)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
  :root{ --bg:#0b0f12; --card:#0f1720; --accent1:#06b6d4; --accent2:#34d399; --muted:#9aa6b2; }
  body.dark { background: linear-gradient(180deg,var(--bg),#071018); color:#e6eef3; }
  body { font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#071018; color:#e6eef3; }
  .navbar-brand{ font-weight:700; color:#fff; }
  .card{ background: linear-gradient(180deg,var(--card), #0b1620); color:inherit; border:none; }
  .flashcard-card{ min-height:160px; display:flex; align-items:center; justify-content:center; cursor:pointer; perspective:900px; }
  .card-face{ backface-visibility:hidden; transition: transform 0.45s ease; transform-origin:center; }
  .front{ font-size:1.2rem; }
  .back{ font-size:1rem; transform: rotateY(180deg); }
  .flashcard-card.flipped .front{ transform: rotateY(180deg); }
  .flashcard-card.flipped .back{ transform: rotateY(0deg); }
  .badge-level{ font-size:0.75rem; }
  .capsule-card{ padding:1rem; }
  .small-muted{ color:var(--muted); font-size:0.85rem; }
  input, textarea { background: rgba(255,255,255,0.02); color:inherit; border:1px solid rgba(255,255,255,0.04); }
  .tab-pane{ min-height:140px; }
  @media (max-width:767px){ .nav .nav-link{ font-size:0.9rem; } }
  </style>
</head>
<body class="dark">
<nav class="navbar navbar-expand-lg sticky-top navbar-dark bg-dark px-3">
  <a class="navbar-brand" href="#">Pocket Classroom</a>
  <div class="ms-auto">
    <button id="btnLibrary" class="btn btn-sm btn-outline-light me-2">Library</button>
    <button id="btnAuthor" class="btn btn-sm btn-outline-light me-2">Author</button>
    <button id="btnLearn" class="btn btn-sm btn-outline-light">Learn</button>
    <button id="themeToggle" class="btn btn-sm btn-link text-light ms-3" aria-label="Toggle theme">ðŸŒ—</button>
  </div>
</nav>

<main class="container my-4">
  <!-- Library -->
  <section id="libraryView" class="view">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Library</h2>
      <div>
        <button id="newCapsuleBtn" class="btn btn-primary me-2">New Capsule</button>
        <label class="btn btn-outline-secondary mb-0">
          Import JSON <input id="importInput" type="file" accept=".json" hidden>
        </label>
      </div>
    </div>
    <div id="capsulesGrid" class="row g-3"></div>
    <div id="emptyLibrary" class="text-center text-muted mt-4" hidden>
      <p>No capsules yet. Click <strong>New Capsule</strong> to start.</p>
    </div>
  </section>

  <!-- Author -->
  <section id="authorView" class="view" hidden>
    <h2 id="authorTitle">Author â€” New Capsule</h2>
    <form id="authorForm" class="mb-4">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Title *</label>
          <input id="metaTitle" class="form-control" required>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Subject</label>
          <input id="metaSubject" class="form-control">
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label">Level</label>
          <select id="metaLevel" class="form-select">
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Advanced</option>
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Description</label>
        <textarea id="metaDescription" class="form-control" rows="2"></textarea>
      </div>

      <hr>
      <h5>Notes</h5>
      <textarea id="notesInput" class="form-control mb-3" rows="4" placeholder="One note per line or Markdown-lite"></textarea>

      <hr>
      <h5>Flashcards</h5>
      <div id="flashcardsList"></div>
      <div class="mt-2">
        <button id="addFlashcardBtn" type="button" class="btn btn-sm btn-outline-primary">Add Card</button>
      </div>

      <hr>
      <h5>Quiz</h5>
      <div id="quizList"></div>
      <div class="mt-2 mb-3">
        <button id="addQuestionBtn" type="button" class="btn btn-sm btn-outline-primary">Add Question</button>
      </div>

      <div class="d-flex justify-content-between">
        <div class="text-muted">Auto-saves as you edit.</div>
        <div>
          <button id="saveCapsuleBtn" class="btn btn-success">Save Capsule</button>
          <button id="cancelAuthorBtn" type="button" class="btn btn-link">Cancel</button>
        </div>
      </div>
    </form>
  </section>

  <!-- Learn -->
  <section id="learnView" class="view" hidden>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 id="learnTitle">Learn</h2>
      <select id="capsuleSelector" class="form-select w-auto"></select>
    </div>

    <div id="learnMeta" class="mb-3 text-muted"></div>

    <ul class="nav nav-tabs" id="learnTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-tab="notes">Notes</button></li>
      <li class="nav-item"><button class="nav-link" data-tab="flashcards">Flashcards</button></li>
      <li class="nav-item"><button class="nav-link" data-tab="quiz">Quiz</button></li>
    </ul>

    <div class="tab-content border p-3 mt-2">
      <div id="tab-notes" class="tab-pane active">
        <div class="mb-2 d-flex justify-content-between">
          <input id="notesSearch" class="form-control w-50" placeholder="Search notes...">
          <button id="exportCapsuleBtn" class="btn btn-outline-secondary">Export Capsule</button>
        </div>
        <ol id="notesDisplay"></ol>
      </div>

      <div id="tab-flashcards" class="tab-pane" hidden>
        <div class="d-flex align-items-center gap-2 mb-2">
          <button id="prevCard" class="btn btn-sm btn-secondary">Prev</button>
          <button id="flipCard" class="btn btn-sm btn-outline-secondary">Flip (Space)</button>
          <button id="nextCard" class="btn btn-sm btn-secondary">Next</button>
          <div class="ms-auto">Known: <span id="knownCount">0</span>/<span id="totalCards">0</span></div>
        </div>
        <div id="flashcardContainer" class="card flashcard-card" tabindex="0" role="button" aria-label="Flashcard">
          <div class="card-body">
            <div id="cardFront" class="card-face front"></div>
            <div id="cardBack" class="card-face back" hidden></div>
          </div>
        </div>
        <div class="mt-2">
          <button id="markKnown" class="btn btn-success btn-sm">Mark Known</button>
          <button id="markUnknown" class="btn btn-outline-danger btn-sm">Mark Unknown</button>
        </div>
      </div>

      <div id="tab-quiz" class="tab-pane" hidden>
        <div id="quizArea"></div>
        <div class="mt-3 d-flex justify-content-between">
          <div id="quizProgress" class="text-muted"></div>
          <div id="quizResult"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
/* ======= Storage & Utils (single file) ======= */
const INDEX_KEY = 'pc_capsules_index';
function loadIndex(){ try{ return JSON.parse(localStorage.getItem(INDEX_KEY)) || []; }catch(e){ return []; } }
function saveIndex(idx){ localStorage.setItem(INDEX_KEY, JSON.stringify(idx)); }
function saveCapsule(id, obj){ localStorage.setItem('pc_capsule_'+id, JSON.stringify(obj)); }
function loadCapsule(id){ try{ return JSON.parse(localStorage.getItem('pc_capsule_'+id)); }catch(e){ return null; } }
function deleteCapsule(id){ localStorage.removeItem('pc_capsule_'+id); localStorage.removeItem('pc_progress_'+id); const idx = loadIndex().filter(i=>i.id!==id); saveIndex(idx); }
function loadProgress(id){ try{ return JSON.parse(localStorage.getItem('pc_progress_'+id)) || {bestScore:0, knownFlashcards:[]}; }catch(e){ return {bestScore:0, knownFlashcards:[]}; } }
function saveProgress(id, p){ localStorage.setItem('pc_progress_'+id, JSON.stringify(p)); }
function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function timeIso(){ return new Date().toISOString(); }
function timeAgo(iso){ if(!iso) return ''; const diff = Date.now() - new Date(iso).getTime(); const sec = Math.floor(diff/1000); if(sec < 60) return sec+'s ago'; const min = Math.floor(sec/60); if(min < 60) return min+'m ago'; const hr = Math.floor(min/60); if(hr < 24) return hr+'h ago'; const d = Math.floor(hr/24); return d+'d ago'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c])); }
function generateId(){ return 'capsule_'+Date.now()+'_'+Math.floor(Math.random()*1000); }

/* ======= App logic ======= */
const $ = sel => document.querySelector(sel);
const $all = sel => Array.from(document.querySelectorAll(sel));
let editingId = null;
let activeCapsuleId = null;

function showView(name){ $all('.view').forEach(s=>s.hidden=true); $('#'+name+'View').hidden=false; }
function initNav(){ $('#btnLibrary').onclick = ()=>{ showView('library'); renderLibrary(); }; $('#btnAuthor').onclick = ()=>{ openAuthor(); }; $('#btnLearn').onclick = ()=>{ openLearn(); }; $('#themeToggle').onclick = toggleTheme; }
function toggleTheme(){ document.body.classList.toggle('dark'); }

function renderLibrary(){
  const grid = $('#capsulesGrid'); grid.innerHTML='';
  const idx = loadIndex();
  if(idx.length===0){ $('#emptyLibrary').hidden=false; return; } else { $('#emptyLibrary').hidden=true; }
  idx.sort((a,b)=> new Date(b.updatedAt)-new Date(a.updatedAt));
  idx.forEach(item=>{
    const card = document.createElement('div'); card.className='col-sm-6 col-md-4';
    card.innerHTML = `<div class="card capsule-card">
      <div class="d-flex justify-content-between">
        <h5>${escapeHtml(item.title)}</h5>
        <span class="badge bg-info badge-level">${escapeHtml(item.level)}</span>
      </div>
      <div class="small-muted">${escapeHtml(item.subject||'')}</div>
      <div class="mt-2 small-muted">Updated: ${timeAgo(item.updatedAt)}</div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-sm btn-primary btn-learn" data-id="${item.id}">Learn</button>
        <button class="btn btn-sm btn-outline-light btn-edit" data-id="${item.id}">Edit</button>
        <button class="btn btn-sm btn-outline-secondary btn-export" data-id="${item.id}">Export</button>
        <button class="btn btn-sm btn-danger btn-delete ms-auto" data-id="${item.id}">Delete</button>
      </div>
    </div>`;
    grid.appendChild(card);
  });
  $all('.btn-learn').forEach(b=>b.onclick = e=>{ openLearn(b.dataset.id); });
  $all('.btn-edit').forEach(b=>b.onclick = e=>{ openAuthor(b.dataset.id); });
  $all('.btn-export').forEach(b=>b.onclick = e=>{ exportCapsule(b.dataset.id); });
  $all('.btn-delete').forEach(b=>b.onclick = e=>{ if(confirm('Delete capsule?')){ deleteCapsule(b.dataset.id); renderLibrary(); }});
}

function openAuthor(id){
  editingId = id || null;
  showView('author');
  $('#authorForm').reset?.();
  $('#flashcardsList').innerHTML=''; $('#quizList').innerHTML='';
  if(id){
    $('#authorTitle').textContent = 'Author â€” Edit Capsule';
    const cap = loadCapsule(id);
    if(cap){
      $('#metaTitle').value = cap.meta.title || '';
      $('#metaSubject').value = cap.meta.subject || '';
      $('#metaLevel').value = cap.meta.level || 'Beginner';
      $('#metaDescription').value = cap.meta.description || '';
      $('#notesInput').value = (cap.notes||[]).join('\\n');
      (cap.flashcards||[]).forEach(fc=> addFlashcardRow(fc.front, fc.back));
      (cap.quiz||[]).forEach(q=> addQuestionRow(q.question, q.choices, q.answerIndex, q.explanation));
    }
  } else {
    $('#authorTitle').textContent = 'Author â€” New Capsule';
    addFlashcardRow(); addQuestionRow();
  }
  setupAuthorAutosave();
}

function addFlashcardRow(front='', back=''){
  const container = $('#flashcardsList'); const row = document.createElement('div'); row.className='d-flex gap-2 mb-2';
  row.innerHTML = `<input class="form-control fc-front" placeholder="Front" value="${escapeHtml(front)}">
  <input class="form-control fc-back" placeholder="Back" value="${escapeHtml(back)}">
  <button class="btn btn-outline-danger btn-sm btn-remove">âœ•</button>`;
  container.appendChild(row);
  row.querySelector('.btn-remove').onclick = ()=>{ row.remove(); };
}

function addQuestionRow(q='', choices=['','','',''], ans=0, exp=''){
  const container = $('#quizList');
  const row = document.createElement('div'); row.className='mb-3 p-2 border rounded';
  row.innerHTML = `<div><input class="form-control q-question" placeholder="Question" value="${escapeHtml(q)}"></div>
  <div class="mt-2 d-grid gap-2">
    ${[0,1,2,3].map(i=>`<div class="input-group input-group-sm">
      <span class="input-group-text">${['A','B','C','D'][i]}</span>
      <input class="form-control q-choice" data-index="${i}" value="${escapeHtml(choices[i]||'')}">
    </div>`).join('')}
    <div class="mt-2 d-flex gap-2">
      <select class="form-select form-select-sm q-answer" style="width:120px">
        <option value="0">Answer: A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
      </select>
      <input class="form-control form-control-sm q-expl" placeholder="Explanation (optional)" value="${escapeHtml(exp)}">
      <button class="btn btn-outline-danger btn-sm ms-auto btn-remove-q">Remove</button>
    </div>
  </div>`;
  container.appendChild(row);
  row.querySelector('.q-answer').value = String(ans||0);
  row.querySelector('.btn-remove-q').onclick = ()=> row.remove();
}

function setupAuthorAutosave(){
  const formEls = ['#metaTitle','#metaSubject','#metaLevel','#metaDescription','#notesInput'];
  formEls.forEach(s=> { const el = document.querySelector(s); if(el) el.oninput = saveDraft; });
  document.querySelectorAll('.fc-front, .fc-back, .q-question, .q-choice, .q-answer, .q-expl').forEach(i=>i.oninput = saveDraft);
}
function collectAuthor(){
  const title = $('#metaTitle').value.trim();
  const subject = $('#metaSubject').value.trim();
  const level = $('#metaLevel').value;
  const description = $('#metaDescription').value.trim();
  const notes = $('#notesInput').value.split('\\n').map(s=>s.trim()).filter(Boolean);
  const flashcards = Array.from(document.querySelectorAll('#flashcardsList .d-flex')).map(r=>{
    const f = r.querySelector('.fc-front').value.trim();
    const b = r.querySelector('.fc-back').value.trim();
    return {front:f, back:b};
  }).filter(c=>c.front||c.back);
  const quiz = Array.from(document.querySelectorAll('#quizList .p-2')).map(r=>{
    const question = r.querySelector('.q-question').value.trim();
    const choices = Array.from(r.querySelectorAll('.q-choice')).map(i=>i.value.trim());
    const answerIndex = Number(r.querySelector('.q-answer').value);
    const explanation = r.querySelector('.q-expl').value.trim();
    return {question, choices, answerIndex, explanation};
  }).filter(q=>q.question && q.choices.some(Boolean));
  return {meta:{title,subject,level,description}, notes, flashcards, quiz};
}

$('#saveCapsuleBtn')?.addEventListener('click', (e)=>{
  e.preventDefault();
  const data = collectAuthor();
  if(!data.meta.title){ alert('Title is required'); return; }
  if(!(data.notes.length||data.flashcards.length||data.quiz.length)){ alert('Add at least notes, flashcards, or quiz'); return; }
  const id = editingId || generateId();
  const capsule = {schema:'pocket-classroom/v1', id, ...data, updatedAt: timeIso()};
  saveCapsule(id, capsule);
  const idx = loadIndex().filter(i=>i.id!==id);
  idx.push({id, title:capsule.meta.title, subject:capsule.meta.subject, level:capsule.meta.level, updatedAt:capsule.updatedAt});
  saveIndex(idx);
  alert('Saved');
  editingId = null;
  renderLibrary();
  showView('library');
});
$('#cancelAuthorBtn')?.addEventListener('click', ()=>{ showView('library'); renderLibrary(); });
function saveDraft(){ /* placeholder for future draft feature */ }

function openLearn(id){
  showView('learn');
  const sel = $('#capsuleSelector'); sel.innerHTML='';
  const idx = loadIndex();
  idx.forEach(i=> { const opt = document.createElement('option'); opt.value=i.id; opt.textContent = i.title; sel.appendChild(opt); });
  if(idx.length===0){ alert('No capsules to learn. Create one first.'); openAuthor(); return; }
  activeCapsuleId = id || sel.value;
  $('#capsuleSelector').value = activeCapsuleId;
  $('#capsuleSelector').onchange = ()=> { activeCapsuleId = $('#capsuleSelector').value; loadLearnState(); };
  $all('#learnTabs .nav-link').forEach(b=> b.onclick = (e)=> { $all('#learnTabs .nav-link').forEach(n=>n.classList.remove('active')); b.classList.add('active'); switchTab(b.dataset.tab); });
  document.addEventListener('keydown', keyHandler);
  loadLearnState();
}

function keyHandler(e){
  if(document.activeElement && ['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.key === ' ') { e.preventDefault(); if($('#tab-flashcards').hidden) return; flipCard(); }
  if(e.key === '[' || e.key === ']'){ cycleTabs(e.key === ']' ? 1 : -1); }
}
function cycleTabs(dir){
  const tabs = ['notes','flashcards','quiz'];
  let cur = tabs.findIndex(t=> !$('#tab-'+t).hidden);
  cur = (cur + dir + tabs.length) % tabs.length;
  $all('#learnTabs .nav-link').forEach(n=> n.classList.remove('active'));
  const btn = $all('#learnTabs .nav-link')[cur]; btn.classList.add('active'); switchTab(btn.dataset.tab);
}
function switchTab(tab){
  ['notes','flashcards','quiz'].forEach(t=> {
    const pane = $('#tab-'+t);
    if(t===tab){ pane.hidden=false; pane.classList.add('active'); } else { pane.hidden=true; pane.classList.remove('active'); }
  });
  if(tab==='notes') renderNotes();
  if(tab==='flashcards') renderFlashcards();
  if(tab==='quiz') startQuiz();
}

function loadLearnState(){
  const cap = loadCapsule(activeCapsuleId);
  if(!cap) return;
  $('#learnTitle').textContent = 'Learn â€” ' + cap.meta.title;
  $('#learnMeta').textContent = `${cap.meta.subject || ''} â€¢ ${cap.meta.level || ''}`;
  switchTab('notes');
}

function renderNotes(){
  const cap = loadCapsule(activeCapsuleId);
  const list = $('#notesDisplay'); list.innerHTML='';
  if(!cap || !(cap.notes||[]).length){ list.innerHTML='<li class="text-muted">No notes</li>'; return; }
  const q = $('#notesSearch').value.trim().toLowerCase();
  (cap.notes||[]).forEach(n=>{
    if(q && !n.toLowerCase().includes(q)) return;
    const li = document.createElement('li'); li.innerHTML = escapeHtml(n);
    list.appendChild(li);
  });
}
$('#notesSearch').oninput = () => { if(!$('#tab-notes').hidden) renderNotes(); }

let fcIndex = 0, fcFlipped=false, fcList=[];
function renderFlashcards(){
  const cap = loadCapsule(activeCapsuleId);
  fcList = cap?.flashcards || [];
  $('#totalCards').textContent = fcList.length;
  const prog = loadProgress(activeCapsuleId);
  $('#knownCount').textContent = (prog.knownFlashcards||[]).length;
  if(fcList.length===0){ $('#flashcardContainer .card-body').innerHTML='<div class="text-muted">No flashcards</div>'; return; }
  fcIndex = Math.min(fcIndex, fcList.length-1);
  showCard();
  $('#prevCard').onclick = ()=>{ fcIndex = Math.max(0, fcIndex-1); showCard(); };
  $('#nextCard').onclick = ()=>{ fcIndex = Math.min(fcList.length-1, fcIndex+1); showCard(); };
  $('#flipCard').onclick = flipCard;
  $('#markKnown').onclick = ()=>{ toggleKnown(true); };
  $('#markUnknown').onclick = ()=>{ toggleKnown(false); };
  document.querySelector('#flashcardContainer').onclick = flipCard;
}
function showCard(){
  const c = fcList[fcIndex];
  $('#cardFront').textContent = c?.front || '';
  $('#cardBack').textContent = c?.back || '';
  fcFlipped = false; document.querySelector('.flashcard-card').classList.remove('flipped');
}
function flipCard(){ fcFlipped = !fcFlipped; document.querySelector('.flashcard-card').classList.toggle('flipped'); }
function toggleKnown(markKnown){
  const prog = loadProgress(activeCapsuleId);
  prog.knownFlashcards = prog.knownFlashcards || [];
  const idx = prog.knownFlashcards.indexOf(fcIndex);
  if(markKnown && idx===-1) prog.knownFlashcards.push(fcIndex);
  if(!markKnown && idx!==-1) prog.knownFlashcards.splice(idx,1);
  saveProgress(activeCapsuleId, prog);
  $('#knownCount').textContent = prog.knownFlashcards.length;
}

let quizState = null;
function startQuiz(){
  const cap = loadCapsule(activeCapsuleId);
  const questions = (cap?.quiz || []).slice();
  quizState = {questions, idx:0, correct:0};
  renderQuizQuestion();
}
function renderQuizQuestion(){
  const area = $('#quizArea'); area.innerHTML='';
  if(!quizState || quizState.questions.length===0){ area.innerHTML='<div class="text-muted">No quiz questions</div>'; return; }
  const q = quizState.questions[quizState.idx];
  const card = document.createElement('div'); card.className='p-3 border rounded';
  card.innerHTML = `<div><strong>Q${quizState.idx+1}.</strong> ${escapeHtml(q.question)}</div>
    <div class="mt-2 d-grid gap-2">${q.choices.map((c,i)=>`<button class="btn btn-outline-light q-choice" data-i="${i}">${['A','B','C','D'][i]}. ${escapeHtml(c)}</button>`).join('')}</div>
    <div class="mt-2 small-muted" id="quizFeedback"></div>`;
  area.appendChild(card);
  $all('.q-choice').forEach(b=> b.onclick = ()=> { const chosen = Number(b.dataset.i); handleAnswer(chosen); });
  $('#quizProgress').textContent = `Question ${quizState.idx+1} / ${quizState.questions.length}`;
}
function handleAnswer(chosen){
  const q = quizState.questions[quizState.idx];
  const fb = $('#quizArea #quizFeedback');
  if(chosen === q.answerIndex){ quizState.correct++; fb.textContent = 'Correct!'; }
  else { fb.textContent = 'Incorrect. Answer: ' + ['A','B','C','D'][q.answerIndex] + '. ' + (q.explanation||''); }
  setTimeout(()=>{ quizState.idx++; if(quizState.idx >= quizState.questions.length){ finishQuiz(); } else renderQuizQuestion(); }, 800);
}
function finishQuiz(){
  const pct = Math.round((quizState.correct / quizState.questions.length) * 100);
  $('#quizResult').innerHTML = `<strong>Score: ${pct}% (${quizState.correct}/${quizState.questions.length})</strong>`;
  const prog = loadProgress(activeCapsuleId);
  prog.bestScore = Math.max(prog.bestScore||0, pct);
  saveProgress(activeCapsuleId, prog);
  $('#quizProgress').textContent = 'Completed';
}

function exportCapsule(id){
  const cap = loadCapsule(id);
  if(!cap) return alert('Not found');
  const blob = new Blob([JSON.stringify(cap, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = (cap.meta.title?cap.meta.title:'capsule')+'.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

$('#newCapsuleBtn').onclick = ()=> openAuthor();
$('#addFlashcardBtn').onclick = ()=> addFlashcardRow();
$('#addQuestionBtn').onclick = ()=> addQuestionRow();

$('#importInput').onchange = function(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{
      const obj = JSON.parse(ev.target.result);
      if(obj.schema !== 'pocket-classroom/v1') throw new Error('Invalid schema');
      const id = generateId();
      obj.id = id; obj.updatedAt = timeIso();
      saveCapsule(id, obj);
      const idx = loadIndex(); idx.push({id, title:obj.meta.title, subject:obj.meta.subject, level:obj.meta.level, updatedAt:obj.updatedAt});
      saveIndex(idx);
      alert('Imported');
      renderLibrary();
    }catch(err){ alert('Import failed: ' + err.message); }
  };
  r.readAsText(f);
};

$('#exportCapsuleBtn').onclick = ()=> { if(activeCapsuleId) exportCapsule(activeCapsuleId); };

document.addEventListener('DOMContentLoaded', ()=>{
  initNav(); // ensure at least one sample exists
  if(!loadIndex().length){
    const sample = {
      "schema":"pocket-classroom/v1",
      "id":"sample_1",
      "meta":{"title":"Sample: Photosynthesis","subject":"Biology","level":"Beginner","description":"Short capsule about photosynthesis."},
      "notes":["Plants convert light energy into chemical energy.","Occurs in chloroplasts."],
      "flashcards":[{"front":"Where does photosynthesis occur?","back":"Chloroplasts"},{"front":"What is the main pigment?","back":"Chlorophyll"}],
      "quiz":[{"question":"Photosynthesis occurs in?","choices":["Mitochondria","Chloroplasts","Nucleus","Ribosome"],"answerIndex":1,"explanation":"Chloroplasts contain chlorophyll."}],
      "updatedAt": timeIso()
    };
    saveCapsule(sample.id, sample);
    saveIndex([{id:sample.id, title:sample.meta.title, subject:sample.meta.subject, level:sample.meta.level, updatedAt:sample.updatedAt}]);
  }
  renderLibrary();
});
</script>
</body>
</html>
