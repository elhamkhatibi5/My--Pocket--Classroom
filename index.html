
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pocket Classroom — Mini E-Learning Platform</title>

  <!-- FAVICON (inline SVG) -->
  <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="%2306b6b4"/><stop offset="1" stop-color="%2306b6ee"/></linearGradient></defs><rect rx="20" width="100" height="100" fill="url(%23g)"/><text x="50" y="58" font-size="44" font-family="Helvetica,Arial" fill="white" text-anchor="middle" font-weight="700">PC</text></svg>'>

  <!-- Google-font-like fallback (use system fonts for offline) -->
  <style>
    :root{
      --bg-900: #041021;
      --bg-800: #071426;
      --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
      --muted: #9fb0c6;
      --accent-1: #06b6b4;
      --accent-2: #06b6ee;
      --card-shadow: 0 10px 30px rgba(2,6,12,0.6);
      --radius: 14px;
      --glass-border: rgba(255,255,255,0.03);
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --glass-glow: 0 6px 30px rgba(5,46,72,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Naskh Arabic UI";
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(6,182,180,0.06), transparent),
        linear-gradient(180deg,var(--bg-900) 0%, #041827 50%, #071426 100%);
      color: #e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
      line-height:1.45;
    }

    /* layout */
    .wrap{max-width:1200px;margin:28px auto;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:18px}
    header.topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:12px 16px;border:1px solid var(--glass-border);box-shadow:var(--card-shadow);
      position:sticky;top:18px;z-index:40;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent-1),var(--accent-2));font-weight:700;font-size:18px;color:white;box-shadow:var(--glass-glow)
    }
    .brand .title{font-weight:700}
    .brand .sub{font-size:0.82rem;color:var(--muted)}
    nav.topnav{display:flex;gap:8px;align-items:center}
    nav.topnav a{color:rgba(230,238,246,0.85);text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:600}
    nav.topnav a.active, nav.topnav a:hover{background:rgba(255,255,255,0.03);color:white}

    /* search + actions */
    .actions{display:flex;gap:8px;align-items:center}
    input.search{
      min-width:240px;padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;
      outline:none;font-size:0.95rem
    }
    button.btn{cursor:pointer;border:0;padding:8px 12px;border-radius:999px;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#001;box-shadow:0 6px 18px rgba(6,182,180,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit}
    .btn.success{background:var(--success);color:white}

    /* main panels */
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:16px; border:1px solid var(--glass-border); box-shadow:0 8px 30px rgba(0,0,0,0.4)}
    .panel h4{margin:0 0 6px 0}
    .muted{color:var(--muted);font-size:0.87rem}

    /* library grid */
    .library-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));
      border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);transition:transform .16s ease, box-shadow .16s ease;
    }
    .card:hover{transform:translateY(-8px);box-shadow:var(--card-shadow)}
    .card .title{font-weight:700}
    .tags{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;color:var(--muted);font-size:0.78rem}

    .card .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .card .meta small{color:var(--muted)}

    .card .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;color:inherit;font-weight:700}

    /* create form */
    form.row{display:flex;flex-direction:column;gap:10px}
    .form-row{display:flex;gap:8px;flex-wrap:wrap}
    .form-control, .form-select, textarea{width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit;outline:none}
    textarea{min-height:120px;resize:vertical}

    /* study area */
    .study-dashboard{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .study-queue{max-height:420px;overflow:auto;padding:6px;background:var(--glass-2);border-radius:8px}
    .study-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));margin-bottom:8px;border:1px solid rgba(255,255,255,0.02)}
    .study-card{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));border:1px solid rgba(255,255,255,0.02)}
    .progress-pill{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-weight:700}

    /* aside */
    aside{position:sticky;top:120px}
    .notes{width:100%;min-height:160px;border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}

    footer{opacity:0.6;text-align:center;padding:12px 0;font-size:0.9rem;color:var(--muted)}

    /* small screens */
    @media (max-width:1100px){
      .wrap{grid-template-columns:1fr; padding:12px}
      .study-dashboard{grid-template-columns:1fr;gap:12px}
      aside{position:static}
    }

    /* super small */
    @media (max-width:520px){
      input.search{min-width:140px}
      .brand .title{font-size:1rem}
    }

    /* small helper */
    .muted.small{font-size:0.82rem;color:var(--muted)}
    .text-right{direction:ltr;text-align:left}
    .hidden{display:none}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="logo" aria-hidden="true">PC</div>
      <div>
        <div class="title">Pocket Classroom</div>
        <div class="sub">Mini E-Learning Platform</div>
      </div>
    </div>

    <nav class="topnav" role="navigation" aria-label="Main">
      <a href="#" class="nav-link active" data-section="library">کتابخانه</a>
      <a href="#" class="nav-link" data-section="create">ایجاد</a>
      <a href="#" class="nav-link" data-section="study">مطالعه</a>
    </nav>

    <div class="actions" role="search">
      <input id="global-search" class="search" placeholder="جستجوی کپسول یا تگ..." aria-label="Search">
      <button id="btn-new" class="btn primary" title="New Capsule">+ جدید</button>
      <button id="export-all" class="btn ghost" title="Export">خروجی</button>
      <button id="import-all" class="btn ghost" title="Import">ورودی</button>
      <input id="file-import" type="file" accept=".json" style="display:none">
    </div>
  </header>

  <!-- APP -->
  <div class="wrap" role="main">
    <main>
      <!-- LIBRARY -->
      <section id="section-library" class="panel" aria-labelledby="lib-h">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <h4 id="lib-h">کتابخانه</h4>
            <div class="muted small">کپسول‌ها و محتوای آموزشی شما</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="muted small">کپسول‌ها: <strong id="capsule-count">0</strong></div>
            <select id="filter-type" class="form-select" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:10px">
              <option value="">همه انواع</option>
              <option value="note">یادداشت</option>
              <option value="flashcards">فلش‌کارت</option>
              <option value="quiz">سوال/آزمون</option>
            </select>
            <select id="sort-select" class="form-select" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:10px">
              <option value="date-desc">جدیدترین</option>
              <option value="date-asc">قدیمی‌ترین</option>
              <option value="title-asc">حروف الفبا A→Z</option>
              <option value="title-desc">حروف الفبا Z→A</option>
            </select>
          </div>
        </div>

        <div id="library-list" class="library-grid" style="margin-top:14px"></div>
      </section>

      <!-- CREATE -->
      <section id="section-create" class="panel hidden" aria-labelledby="create-h">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h4 id="create-h">ایجاد / ویرایش کپسول</h4>
            <div class="muted small">Notes, Flashcards یا Quiz</div>
          </div>
          <div class="muted small">نوع: <span id="capsule-type-label">Note</span></div>
        </div>

        <form id="capsule-form" class="row" novalidate>
          <input type="hidden" id="editing-id" value="">
          <div class="form-row">
            <div style="flex:1">
              <label class="muted small">عنوان</label>
              <input id="capsule-title" class="form-control" placeholder="مثال: مقدمه‌ای بر فتوسنتز" required>
            </div>
            <div style="width:220px">
              <label class="muted small">تگ‌ها</label>
              <input id="capsule-tags" class="form-control" placeholder="با کاما جدا کنید">
            </div>
          </div>

          <div class="form-row" style="align-items:end">
            <div style="width:200px">
              <label class="muted small">نوع</label>
              <select id="capsule-type" class="form-select">
                <option value="note">یادداشت</option>
                <option value="flashcards">فلش‌کارت</option>
                <option value="quiz">آزمون</option>
              </select>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button type="submit" class="btn success">ذخیره</button>
              <button id="cancel-edit" type="button" class="btn ghost">انصراف</button>
            </div>
          </div>

          <!-- Note -->
          <div id="note-wrapper" style="margin-top:6px">
            <label class="muted small">محتوا</label>
            <textarea id="capsule-content" rows="6" class="form-control" placeholder="خلاصه‌ی درس، نکات یا دستورالعمل..."></textarea>
          </div>

          <!-- Flashcards -->
          <div id="flash-wrapper" class="hidden" style="margin-top:6px">
            <label class="muted small">فلش‌کارت‌ها</label>
            <div id="flash-list" style="margin-top:8px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="fc-front" class="form-control" placeholder="پرسش (رو)">
              <input id="fc-back" class="form-control" placeholder="پاسخ (پشت)">
              <button id="add-fc" type="button" class="btn primary">افزودن</button>
            </div>
            <div class="muted small" style="margin-top:6px">نکته: ترتیب کشیدنی در این نسخه فعال نیست.</div>
          </div>

          <!-- Quiz -->
          <div id="quiz-wrapper" class="hidden" style="margin-top:6px">
            <label class="muted small">سوالات چندگزینه‌ای (MCQ)</label>
            <div id="quiz-list" style="margin-top:8px"></div>

            <div class="form-row" style="margin-top:8px">
              <input id="q-text" class="form-control" placeholder="متن سوال">
              <div style="width:260px;display:flex;gap:8px">
                <input id="q-opt1" class="form-control" placeholder="گزینه A">
                <input id="q-opt2" class="form-control" placeholder="گزینه B">
              </div>
            </div>
            <div class="form-row" style="margin-top:8px">
              <div style="flex:1;display:flex;gap:8px">
                <input id="q-opt3" class="form-control" placeholder="گزینه C (اختیاری)">
                <input id="q-opt4" class="form-control" placeholder="گزینه D (اختیاری)">
              </div>
              <div style="width:140px">
                <select id="q-correct" class="form-select">
                  <option value="1">صحیح: A</option>
                  <option value="2">صحیح: B</option>
                  <option value="3">صحیح: C</option>
                  <option value="4">صحیح: D</option>
                </select>
              </div>
              <div style="width:110px">
                <button id="add-q" type="button" class="btn primary">افزودن سوال</button>
              </div>
            </div>
            <div class="muted small" style="margin-top:6px">حداقل گزینه‌های A و B لازم است.</div>
          </div>
        </form>
      </section>

      <!-- STUDY -->
      <section id="section-study" class="panel hidden" aria-labelledby="study-h">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h4 id="study-h">مطالعه</h4>
            <div class="muted small">صفحهٔ مطالعه — انتخاب کپسول‌ها و ساخت صف</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="study-filter" class="form-select" style="width:160px">
              <option value="all">همه</option>
              <option value="new">جدید</option>
              <option value="review">برای مرور</option>
            </select>
            <button id="study-start" class="btn primary">شروع جلسه</button>
            <button id="study-shuffle" class="btn ghost">در هم</button>
          </div>
        </div>

        <div class="study-dashboard" style="margin-top:10px">
          <div>
            <label class="muted small">انتخاب کپسول‌ها برای افزودن به صف</label>
            <div id="study-capsule-list" class="library-grid" style="margin-top:8px"></div>

            <div style="margin-top:12px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="muted">صف مطالعه</div>
                <div class="muted small">تعداد: <strong id="queue-count">0</strong></div>
              </div>
              <div id="study-queue" class="study-queue" style="margin-top:8px"></div>
            </div>
          </div>

          <div>
            <div class="study-card" id="active-study-card">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div class="muted small" id="active-meta">بدون جلسهٔ فعال</div>
                  <div class="h4 fw-bold" id="active-front" style="margin-top:8px">برای دیدن کارت‌ها جلسه شروع کنید</div>
                </div>
                <div style="text-align:left">
                  <div class="progress-pill muted small" id="active-mode">—</div>
                </div>
              </div>

              <div id="active-back" class="muted small text-right" style="display:none;margin-top:12px"></div>

              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="btn-show-answer" class="btn ghost">نمایش پاسخ</button>
                <button id="btn-mark-learned" class="btn success">آموخته</button>
                <button id="btn-skip" class="btn ghost" style="margin-left:auto">رد کردن</button>
              </div>

              <div class="muted small" id="session-stats" style="margin-top:10px">جلسه: 0 / 0</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- RIGHT COLUMN -->
    <aside>
      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h6 style="margin:0">یادداشت سریع</h6>
          <div class="muted small">ذخیره خودکار</div>
        </div>
        <textarea id="notes" class="notes" placeholder="یادداشت‌ها، وظایف یا یادآوری‌ها..."></textarea>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h6 style="margin:0">گزارش فعالیت</h6>
          <div><button id="clear-log" class="btn ghost">پاک کردن</button></div>
        </div>
        <ul id="log-list" style="list-style:none;padding:0;margin:0;max-height:360px;overflow:auto" class="muted small"></ul>
      </div>
    </aside>
  </div>

  <footer>© 2025 Pocket Classroom — Offline · LocalStorage · Export/Import JSON</footer>

  <!-- SCRIPT (Single-file JS: polished and compatible with earlier behavior) -->
  <script>
    (() => {
      // Keys
      const LS_KEY = 'pc_capsules_v2';
      const LS_NOTES = 'pc_notes_v2';
      const LS_LOG = 'pc_log_v2';

      // App state
      let app = { capsules: [], notes: '', log: [] };
      let tmp = { flash: [], quiz: [] };
      let session = { queue: [], index: 0, learned: new Set(), mode: '', active: null };

      // DOM
      const navLinks = document.querySelectorAll('.nav-link');
      const sections = {
        library: document.getElementById('section-library'),
        create: document.getElementById('section-create'),
        study: document.getElementById('section-study')
      };

      const libraryList = document.getElementById('library-list');
      const capsuleCount = document.getElementById('capsule-count');
      const filterType = document.getElementById('filter-type');
      const sortSelect = document.getElementById('sort-select');
      const globalSearch = document.getElementById('global-search');
      const btnNew = document.getElementById('btn-new');

      const capsuleForm = document.getElementById('capsule-form');
      const editingId = document.getElementById('editing-id');
      const ctTitle = document.getElementById('capsule-title');
      const ctTags = document.getElementById('capsule-tags');
      const ctType = document.getElementById('capsule-type');
      const ctTypeLabel = document.getElementById('capsule-type-label');
      const noteWrapper = document.getElementById('note-wrapper');
      const capsuleContent = document.getElementById('capsule-content');
      const flashWrapper = document.getElementById('flash-wrapper');
      const flashList = document.getElementById('flash-list');
      const fcFront = document.getElementById('fc-front');
      const fcBack = document.getElementById('fc-back');
      const addFc = document.getElementById('add-fc');
      const quizWrapper = document.getElementById('quiz-wrapper');
      const quizList = document.getElementById('quiz-list');
      const qText = document.getElementById('q-text');
      const qOpt1 = document.getElementById('q-opt1');
      const qOpt2 = document.getElementById('q-opt2');
      const qOpt3 = document.getElementById('q-opt3');
      const qOpt4 = document.getElementById('q-opt4');
      const qCorrect = document.getElementById('q-correct');
      const addQ = document.getElementById('add-q');
      const cancelEdit = document.getElementById('cancel-edit');

      const studyCapsuleList = document.getElementById('study-capsule-list');
      const studyQueueEl = document.getElementById('study-queue');
      const queueCount = document.getElementById('queue-count');
      const studyFilter = document.getElementById('study-filter');
      const studyStart = document.getElementById('study-start');
      const studyShuffle = document.getElementById('study-shuffle');

      const activeFront = document.getElementById('active-front');
      const activeBack = document.getElementById('active-back');
      const activeMeta = document.getElementById('active-meta');
      const activeMode = document.getElementById('active-mode');
      const btnShowAnswer = document.getElementById('btn-show-answer');
      const btnMarkLearned = document.getElementById('btn-mark-learned');
      const btnSkip = document.getElementById('btn-skip');
      const sessionStats = document.getElementById('session-stats');

      const notesEl = document.getElementById('notes');
      const exportAllBtn = document.getElementById('export-all');
      const importAllBtn = document.getElementById('import-all');
      const fileImport = document.getElementById('file-import');
      const logList = document.getElementById('log-list');
      const clearLog = document.getElementById('clear-log');

      // utils
      const uid = () => Math.random().toString(36).slice(2,9);
      const now = () => Date.now();
      const escapeHtml = (s='') => String(s).replaceAll('<','&lt;').replaceAll('>','&gt;');
      const parseTags = (s='') => String(s||'').split(',').map(x=>x.trim()).filter(Boolean);

      function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(app.capsules)); }
      function loadState(){ try{ app.capsules = JSON.parse(localStorage.getItem(LS_KEY)) || []; }catch(e){ app.capsules = []; } }
      function saveNotes(){ localStorage.setItem(LS_NOTES, app.notes); }
      function loadNotes(){ app.notes = localStorage.getItem(LS_NOTES) || ''; notesEl.value = app.notes; }
      function saveLog(){ localStorage.setItem(LS_LOG, JSON.stringify(app.log)); }
      function loadLog(){ try{ app.log = JSON.parse(localStorage.getItem(LS_LOG)) || []; }catch(e){ app.log = [] } renderLog(); }

      function log(text){
        app.log.unshift({ id: uid(), text, at: now() });
        if(app.log.length>300) app.log.pop();
        saveLog(); renderLog();
      }

      // rendering
      function renderLibrary(){
        const q = (globalSearch.value || '').toLowerCase();
        const type = filterType.value;
        const sort = sortSelect.value;
        let list = [...app.capsules];

        if(type) list = list.filter(c => c.type === type);
        if(q) list = list.filter(c => (c.title||'').toLowerCase().includes(q) || (c.tags||[]).join(' ').toLowerCase().includes(q) || (c.content||'').toLowerCase().includes(q));

        if(sort==='date-desc') list.sort((a,b)=>b.createdAt - a.createdAt);
        if(sort==='date-asc') list.sort((a,b)=>a.createdAt - b.createdAt);
        if(sort==='title-asc') list.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
        if(sort==='title-desc') list.sort((a,b)=> (b.title||'').localeCompare(a.title||''));

        libraryList.innerHTML = '';
        if(list.length===0){
          libraryList.innerHTML = `<div style="grid-column:1/-1;padding:22px;text-align:center;color:var(--muted)">کتابخانه خالی‌ست — ابتدا یک کپسول ایجاد کن یا نمونه‌ها را بارگذاری کن.</div>`;
        } else {
          list.forEach(c => {
            const el = document.createElement('div'); el.className='card';
            el.innerHTML = `
              <div class="title">${escapeHtml(c.title)}</div>
              <div class="muted small" style="margin-top:6px">${new Date(c.createdAt).toLocaleString()}</div>
              <div class="muted small" style="margin-top:8px">${escapeHtml((c.content||'').slice(0,140))}${(c.content||'').length>140?'...':''}</div>
              <div class="tags">${(c.tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
              <div class="meta">
                <small>${escapeHtml(c.type)}</small>
                <div class="actions">
                  <button class="icon-btn btn-edit" data-id="${c.id}">ویرایش</button>
                  <button class="icon-btn btn-delete" data-id="${c.id}">حذف</button>
                  <button class="icon-btn btn-dup" data-id="${c.id}">کپی</button>
                  <button class="icon-btn btn-study" data-id="${c.id}">مطالعه</button>
                  <button class="icon-btn btn-export" data-id="${c.id}">خروجی</button>
                </div>
              </div>
            `;
            libraryList.appendChild(el);
          });
        }

        capsuleCount.textContent = app.capsules.length;
        renderStudyCapsuleList();
      }

      function renderStudyCapsuleList(){
        studyCapsuleList.innerHTML = '';
        if(app.capsules.length===0){
          studyCapsuleList.innerHTML = `<div style="grid-column:1/-1;padding:12px;color:var(--muted)">کپسولی موجود نیست</div>`;
        } else {
          app.capsules.forEach(c => {
            const el = document.createElement('div'); el.className='card';
            el.innerHTML = `
              <div class="title">${escapeHtml(c.title)}</div>
              <div class="muted small mb-2">${escapeHtml(c.type)} · ${new Date(c.createdAt).toLocaleDateString()}</div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="icon-btn btn-add-queue" data-id="${c.id}">افزودن به صف</button>
                <div class="muted small" style="margin-left:auto">${(c.data||[]).length} مورد</div>
              </div>
            `;
            studyCapsuleList.appendChild(el);
          });
        }
      }

      function renderFlashList(){
        flashList.innerHTML = '';
        (tmp.flash||[]).forEach((f,i) => {
          const el = document.createElement('div'); el.className='study-item';
          el.innerHTML = `<div style="flex:1"><div class="title">${escapeHtml(f.front)}</div><div class="muted small">${escapeHtml(f.back)}</div></div><div><button class="icon-btn btn-del-fc" data-i="${i}">حذف</button></div>`;
          flashList.appendChild(el);
        });
      }

      function renderQuizList(){
        quizList.innerHTML = '';
        (tmp.quiz||[]).forEach((q,i) => {
          const el = document.createElement('div'); el.className='study-item';
          el.innerHTML = `<div style="flex:1"><div class="title">${escapeHtml(q.text)}</div><div class="muted small">A:${escapeHtml(q.opts[0]||'')} B:${escapeHtml(q.opts[1]||'')}</div></div><div><button class="icon-btn btn-del-q" data-i="${i}">حذف</button></div>`;
          quizList.appendChild(el);
        });
      }

      function resetCreateForm(){
        editingId.value=''; ctTitle.value=''; ctTags.value=''; ctType.value='note'; ctTypeLabel.textContent='Note';
        capsuleContent.value=''; flashList.innerHTML=''; quizList.innerHTML='';
        tmp.flash=[]; tmp.quiz=[];
        toggleCreateUI('note');
      }

      function toggleCreateUI(t){
        ctTypeLabel.textContent = t.charAt(0).toUpperCase()+t.slice(1);
        noteWrapper.classList.toggle('hidden', t!=='note');
        flashWrapper.classList.toggle('hidden', t!=='flashcards');
        quizWrapper.classList.toggle('hidden', t!=='quiz');
      }

      // CRUD
      capsuleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = editingId.value || uid();
        const title = ctTitle.value.trim() || 'بدون عنوان';
        const tags = parseTags(ctTags.value);
        const type = ctType.value;
        const nowTs = now();
        const base = { id, title, tags, type, createdAt: nowTs, updatedAt: nowTs, content:'', data:[] };

        if(editingId.value){
          const ex = app.capsules.find(c=>c.id===id);
          if(ex) base.createdAt = ex.createdAt;
        }

        if(type === 'note'){ base.content = capsuleContent.value.trim(); base.data = []; }
        if(type === 'flashcards'){ base.data = (tmp.flash||[]).map(it => ({...it, id: it.id||uid()})); base.content = ''; }
        if(type === 'quiz'){ base.data = (tmp.quiz||[]).map(it => ({...it, id: it.id||uid()})); base.content = ''; }

        const idx = app.capsules.findIndex(c=>c.id===id);
        if(idx>=0){ app.capsules[idx] = base; log(`به‌روز شد: "${title}"`); }
        else { app.capsules.push(base); log(`ذخیره شد: "${title}"`); }

        saveState(); renderLibrary(); resetCreateForm(); showSection('library');
      });

      addFc.addEventListener('click', () => {
        const f = fcFront.value.trim(), b = fcBack.value.trim();
        if(!f || !b) return alert('رو و پشت لازم است.');
        tmp.flash.push({ front: f, back: b, id: uid() });
        fcFront.value=''; fcBack.value=''; renderFlashList();
      });

      addQ.addEventListener('click', () => {
        const text = qText.value.trim();
        if(!text || !qOpt1.value.trim() || !qOpt2.value.trim()) return alert('سوال و گزینه‌های A/B لازم است.');
        const opts = [qOpt1.value.trim(), qOpt2.value.trim(), qOpt3.value.trim()||'', qOpt4.value.trim()||''];
        tmp.quiz.push({ text, opts, correct: Number(qCorrect.value), id: uid() });
        qText.value=''; qOpt1.value=''; qOpt2.value=''; qOpt3.value=''; qOpt4.value=''; qCorrect.value='1';
        renderQuizList();
      });

      // delegated clicks
      document.addEventListener('click', (ev) => {
        const t = ev.target;

        if(t.matches('.btn-del-fc')){ const i = Number(t.dataset.i); if(tmp.flash[i]) tmp.flash.splice(i,1); renderFlashList(); }
        if(t.matches('.btn-del-q')){ const i = Number(t.dataset.i); if(tmp.quiz[i]) tmp.quiz.splice(i,1); renderQuizList(); }

        if(t.matches('.btn-delete')){ const id = t.dataset.id; const cap = app.capsules.find(c=>c.id===id); if(confirm('آیا می‌خواهید حذف شود؟')){ app.capsules = app.capsules.filter(c=>c.id!==id); saveState(); log(`حذف شد: "${cap?.title||id}"`); renderLibrary(); } }
        if(t.matches('.btn-edit')){ openEdit(t.dataset.id); }
        if(t.matches('.btn-dup')){ duplicate(t.dataset.id); }
        if(t.matches('.btn-export')){ exportSingle(t.dataset.id); }
        if(t.matches('.btn-study')){ addCapsuleToQueue(t.dataset.id); showSection('study'); }

        if(t.matches('.btn-add-queue')){ addCapsuleToQueue(t.dataset.id); }

        if(t.matches('.study-queue-item-remove')){ const id = t.dataset.id; session.queue = session.queue.filter(q=>q.queueId !== id); renderQueue(); }

      });

      function openEdit(id){
        const c = app.capsules.find(x=>x.id===id); if(!c) return;
        editingId.value = c.id; ctTitle.value = c.title; ctTags.value = (c.tags||[]).join(', ');
        ctType.value = c.type; ctTypeLabel.textContent = c.type.charAt(0).toUpperCase()+c.type.slice(1);
        if(c.type==='note'){ capsuleContent.value = c.content || ''; }
        if(c.type==='flashcards'){ tmp.flash = JSON.parse(JSON.stringify(c.data||[])); renderFlashList(); }
        if(c.type==='quiz'){ tmp.quiz = JSON.parse(JSON.stringify(c.data||[])); renderQuizList(); }
        toggleCreateUI(c.type); showSection('create');
      }

      function duplicate(id){
        const orig = app.capsules.find(c=>c.id===id); if(!orig) return;
        const copy = JSON.parse(JSON.stringify(orig)); copy.id = uid(); copy.title = orig.title + ' (کپی)'; copy.createdAt = now();
        if(Array.isArray(copy.data)) copy.data = copy.data.map(i=> ({...i, id: uid()}));
        app.capsules.push(copy); saveState(); log(`کپی شد: "${orig.title}"`); renderLibrary();
      }

      function exportSingle(id){
        const cap = app.capsules.find(c=>c.id===id); if(!cap) return;
        const blob = new Blob([JSON.stringify(cap, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `${cap.title.replace(/\s+/g,'_')}.json`; a.click(); URL.revokeObjectURL(url);
        log(`خروجی گرفت: "${cap.title}"`);
      }

      // queue & session
      function addCapsuleToQueue(id){
        const cap = app.capsules.find(c=>c.id===id); if(!cap) return;
        if(!cap.data || cap.data.length===0){ alert('این کپسول آیتم مطالعه ندارد.'); return; }
        cap.data.forEach(item=>{
          session.queue.push({
            queueId: uid(),
            capsuleId: cap.id,
            capsuleTitle: cap.title,
            type: cap.type,
            item: JSON.parse(JSON.stringify(item))
          });
        });
        renderQueue(); log(`به صف اضافه شد: "${cap.title}" (${cap.data.length} مورد)`);
      }

      function renderQueue(){
        studyQueueEl.innerHTML = '';
        session.queue.forEach(q=>{
          const el = document.createElement('div'); el.className='study-item';
          el.innerHTML = `<div><div class="title">${escapeHtml(q.capsuleTitle)}</div><div class="muted small">${escapeHtml(q.type)}</div></div><div style="min-width:110px;text-align:left"><button class="icon-btn study-queue-item-remove" data-id="${q.queueId}">حذف</button></div>`;
          studyQueueEl.appendChild(el);
        });
        queueCount.textContent = session.queue.length;
        updateSessionUI();
      }

      function clearSession(){
        session = { queue: [], index: 0, learned: new Set(), mode: '', active: null };
        renderQueue(); updateSessionUI();
      }

      studyStart.addEventListener('click', ()=> {
        if(session.queue.length===0){ alert('صف خالی است. ابتدا کپسول به صف اضافه کنید.'); return; }
        session.index = 0; session.learned = new Set();
        buildSessionMode(); showActiveCard(); log('جلسهٔ مطالعه آغاز شد');
      });

      studyShuffle.addEventListener('click', ()=>{
        if(session.queue.length>1){ shuffle(session.queue); session.index = 0; renderQueue(); showActiveCard(); log('صف درهم شد'); }
      });

      function buildSessionMode(){
        session.mode = session.queue[0]?.type || 'flashcards';
        activeMode.textContent = session.mode.charAt(0).toUpperCase()+session.mode.slice(1);
      }

      function showActiveCard(){
        if(session.queue.length===0){
          activeMeta.textContent = 'بدون جلسهٔ فعال';
          activeFront.textContent = 'برای دیدن کارت‌ها جلسه را شروع کنید';
          activeBack.style.display = 'none';
          sessionStats.textContent = 'جلسه: 0 / 0';
          return;
        }
        const cur = session.queue[session.index];
        if(!cur) return;
        activeMeta.textContent = `${session.index+1} از ${session.queue.length} — ${escapeHtml(cur.capsuleTitle)}`;

        if(cur.type === 'flashcards'){
          activeFront.textContent = cur.item.front || '';
          activeBack.textContent = cur.item.back || '';
          activeBack.style.display = 'none';
          activeMode.textContent = 'فلش‌کارت';
        } else if(cur.type === 'quiz'){
          activeFront.textContent = cur.item.text || '';
          const opts = cur.item.opts || [];
          activeBack.innerHTML = opts.map((o,i)=>`<div>${String.fromCharCode(65+i)}. ${escapeHtml(o)}</div>`).join('');
          activeBack.style.display = 'none';
          activeMode.textContent = 'آزمون';
        } else {
          activeFront.textContent = cur.item.question || cur.item.front || '';
          activeBack.textContent = cur.item.answer || cur.item.back || '';
          activeBack.style.display = 'none';
          activeMode.textContent = cur.type;
        }
        sessionStats.textContent = `جلسه: ${session.learned.size} / ${session.queue.length}`;
        updateSessionUI();
      }

      btnShowAnswer.addEventListener('click', ()=> {
        if(!activeBack.innerHTML) return;
        activeBack.style.display = activeBack.style.display === 'none' ? 'block' : 'none';
      });

      btnMarkLearned.addEventListener('click', ()=> {
        const q = session.queue[session.index];
        if(!q) return;
        session.learned.add(q.queueId);
        // move forward to next not-learned or finish
        const next = session.index + 1;
        if(next < session.queue.length){
          session.index = next; showActiveCard();
        } else {
          showActiveCard();
          log('جلسهٔ مطالعه به پایان رسید');
          alert(`جلسه تمام شد. آموختی: ${session.learned.size} از ${session.queue.length} مورد.`);
        }
      });

      btnSkip.addEventListener('click', ()=> {
        if(session.queue.length===0) return;
        session.index = (session.index + 1) % session.queue.length;
        showActiveCard();
      });

      function updateSessionUI(){
        const q = session.queue[session.index];
        btnMarkLearned.disabled = !q || session.learned.has(q.queueId);
        sessionStats.textContent = `جلسه: ${session.learned.size} / ${session.queue.length}`;
        queueCount.textContent = session.queue.length;
      }

      function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

      // Import / Export
      exportAllBtn.addEventListener('click', ()=> {
        const blob = new Blob([JSON.stringify(app.capsules, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pocket_classroom_export_${now()}.json`; a.click(); URL.revokeObjectURL(url);
        log('خروجی تمام کتابخانه');
      });

      importAllBtn.addEventListener('click', ()=> fileImport.click());
      fileImport.addEventListener('change', (e)=> {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const data = JSON.parse(ev.target.result);
            if(Array.isArray(data)){
              const existing = new Set(app.capsules.map(c=>c.id));
              data.forEach(c=>{
                if(!c.id) c.id = uid();
                if(existing.has(c.id)){
                  const copy = {...c, id: uid(), title: (c.title||'بدون عنوان') + ' (import)'};
                  if(Array.isArray(copy.data)) copy.data = copy.data.map(it=> ({...it, id: it.id||uid()}));
                  app.capsules.push(copy);
                } else {
                  if(Array.isArray(c.data)) c.data = c.data.map(it=> ({...it, id: it.id||uid()}));
                  app.capsules.push(c);
                }
              });
              saveState(); renderLibrary(); log('وارد کردن: آرایه کتابخانه');
            } else if(data && data.id){
              if(!app.capsules.find(x=>x.id===data.id)){
                if(Array.isArray(data.data)) data.data = data.data.map(i=>({...i, id: i.id||uid()}));
                app.capsules.push(data); saveState(); renderLibrary(); log(`وارد شد: "${data.title||'بدون عنوان'}"`);
              } else {
                const copy = {...data, id: uid(), title: (data.title||'بدون عنوان') + ' (import)'};
                if(Array.isArray(copy.data)) copy.data = copy.data.map(i=>({...i, id: i.id||uid()}));
                app.capsules.push(copy); saveState(); renderLibrary(); log(`وارد شد (کپی): "${data.title||'بدون عنوان'}"`);
              }
            } else alert('فایل ورودی نامعتبر است.');
          } catch(err){
            alert('خواندن JSON ناموفق بود.');
          }
        };
        reader.readAsText(f);
        e.target.value = '';
      });

      // notes & log
      notesEl.addEventListener('input', ()=>{ app.notes = notesEl.value; saveNotes(); });

      clearLog.addEventListener('click', ()=>{ app.log = []; saveLog(); renderLog(); });

      function renderLog(){
        logList.innerHTML = '';
        app.log.forEach(entry=>{
          const li = document.createElement('li'); li.className='mb-2';
          li.innerHTML = `<div style="font-weight:700;font-size:0.85rem">${new Date(entry.at).toLocaleString()}</div><div class="muted small">${escapeHtml(entry.text)}</div>`;
          logList.appendChild(li);
        });
      }

      // navigation
      navLinks.forEach(link=>{
        link.addEventListener('click', (e)=>{
          e.preventDefault();
          const sec = link.dataset.section;
          showSection(sec);
          navLinks.forEach(l=>l.classList.toggle('active', l===link));
        });
      });

      function showSection(name){
        Object.keys(sections).forEach(k => sections[k].classList.toggle('hidden', k!==name));
        if(name==='create') resetCreateForm();
        if(name==='study'){ renderStudyCapsuleList(); renderQueue(); showActiveCard(); }
        if(name==='library') renderLibrary();
        navLinks.forEach(l=> l.classList.toggle('active', l.dataset.section===name));
      }

      // quick handlers
      btnNew.addEventListener('click', ()=>{ showSection('create'); resetCreateForm(); });
      cancelEdit.addEventListener('click', ()=>{ resetCreateForm(); showSection('library'); });
      ctType.addEventListener('change', (e)=> toggleCreateUI(e.target.value));
      globalSearch.addEventListener('input', renderLibrary);
      filterType.addEventListener('change', renderLibrary);
      sortSelect.addEventListener('change', renderLibrary);

      // seed if empty
      function seedIfEmpty(){
        if(app.capsules.length===0){
          const samples = [
            { id: uid(), title: 'Biology — Photosynthesis', tags:['Biology','Plants'], type:'note', content:'Photosynthesis is the process by which plants convert light energy to chemical energy (glucose) using chlorophyll and sunlight.', data:[], createdAt: now() - 86400000, updatedAt: now()-86400000 },
            { id: uid(), title: 'Basic Spanish — Vocab', tags:['Spanish','Vocab'], type:'flashcards', content:'', data:[
              { id: uid(), front:'Hello', back:'Hola' },
              { id: uid(), front:'Thank you', back:'Gracias' },
              { id: uid(), front:'Please', back:'Por favor' }
            ], createdAt: now()-3600000, updatedAt: now()-3600000 },
            { id: uid(), title: 'JS Quiz — Basics', tags:['JS','Quiz'], type:'quiz', content:'', data:[
              { id: uid(), text:'Which keyword declares a block-scoped variable?', opts:['var','let','function','const'], correct:2, id: uid() },
              { id: uid(), text:'Which method parses a JSON string?', opts:['JSON.parse','JSON.stringify','Object.fromJSON','parseJSON'], correct:1, id: uid() }
            ], createdAt: now()-1800000, updatedAt: now()-1800000 }
          ];
          app.capsules = samples; saveState(); log('نمونه‌ها بارگذاری شد');
        }
      }

      // keyboard
      document.addEventListener('keydown', (e)=>{
        if(e.ctrlKey && e.key.toLowerCase() === 'k'){ e.preventDefault(); globalSearch.focus(); }
        if(e.key === 'F1'){ e.preventDefault(); alert('راهنما: از تب‌ها برای رفتن به Library / Create / Study استفاده کنید. Ctrl+K برای جستجو.'); }
      });

      // init
      tmp.flash = tmp.flash || []; tmp.quiz = tmp.quiz || [];
      loadState(); loadNotes(); loadLog(); seedIfEmpty(); renderLibrary(); renderFlashList(); renderQuizList();

    })();
  </script>
</body>
</html>
