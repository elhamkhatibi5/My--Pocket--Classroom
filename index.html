<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>pocket-classroom — Offline (Modern)</title>
<style>
  /* ===== Reset + Base ===== */
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: #071026;
    color: #e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;flex-direction:column;
    min-height:100vh;
  }

  /* ===== Background: inline SVG bookshelf (data URI) ===== */
  :root{--panel-bg: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));}
  body::before{
    content:"";
    position:fixed;inset:0;z-index:-1;
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(0,120,255,0.06), transparent 12%),
      radial-gradient(900px 400px at 90% 85%, rgba(0,210,255,0.03), transparent 12%),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900" viewBox="0 0 1600 900"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="%2305182a"/><stop offset="1" stop-color="%230b2333"/></linearGradient></defs><rect width="100%" height="100%" fill="url(%23g)"/><g opacity="0.08"><rect x="60" y="60" width="240" height="28" rx="6" fill="%23fff"/><rect x="60" y="110" width="240" height="220" rx="6" fill="%23fff"/></g><g opacity="0.05"><rect x="340" y="80" width="200" height="14" rx="6" fill="%23fff"/><rect x="340" y="110" width="200" height="260" rx="6" fill="%23fff"/></g><g opacity="0.06"><rect x="560" y="60" width="700" height="18" rx="6" fill="%23fff"/></g></svg>') center/cover no-repeat;
    filter: blur(22px) saturate(110%);
    transform: scale(1.05);
  }

  /* ===== Topbar ===== */
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:transparent;border-bottom:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,#00d4ff,#0066ff);box-shadow:0 10px 30px rgba(0,102,255,0.12);
  }
  .brand h1{font-size:18px;color:#fff;letter-spacing:-0.3px}
  .brand p{font-size:12px;color:rgba(230,238,248,0.7);margin-top:2px}

  .top-actions{display:flex;align-items:center;gap:8px}
  .btn{background:linear-gradient(90deg,#06b6d4,#0ea5a4);color:#042028;border:none;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(6,182,212,0.09);transition:transform .14s ease}
  .btn:hover{transform:translateY(-3px)}
  .btn.ghost{background:transparent;color:#cde7ff;border:1px solid rgba(255,255,255,0.04);box-shadow:none}
  .small{padding:7px 10px;font-size:13px;border-radius:8px}

  /* ===== Layout ===== */
  main{display:grid;grid-template-columns:320px 1fr 460px;gap:18px;padding:18px;align-items:start;flex:1}
  @media (max-width:1100px){ main{grid-template-columns:1fr;padding:12px} .right-col{order:3} .center-col{order:2} .left-col{order:1} }

  .panel{background:var(--panel-bg);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(2,6,23,0.45)}
  h2{font-size:15px;margin-bottom:8px;color:#e9f6ff}

  /* ===== Library (left) ===== */
  .capsule-list{display:flex;flex-direction:column;gap:12px;max-height:74vh;overflow:auto;padding-right:6px}
  .capsule-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);transition:transform .12s,box-shadow .12s}
  .capsule-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,8,23,0.6)}
  .capsule-title{font-weight:800}
  .capsule-meta{font-size:12px;color:rgba(230,238,248,0.6)}
  .card-actions{display:flex;gap:8px;align-items:center}
  .icon{background:transparent;border:none;color:rgba(230,238,248,0.85);padding:8px;border-radius:8px;cursor:pointer}
  .icon:hover{background:rgba(255,255,255,0.02)}

  /* ===== Center: study ===== */
  .controls-row{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  select{padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dff4ff}
  .progress-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
  .progress-bar{width:220px;height:10px;border-radius:20px;background:rgba(255,255,255,0.03);overflow:hidden}
  .progress-bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#00d4ff,#00aaff);transition:width .25s ease}

  .study-area{display:flex;flex-direction:column;gap:12px}
  .card-large{padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  .fc-front{font-size:22px;font-weight:800;color:#e6f9ff}
  .fc-back{margin-top:12px;font-size:18px;color:#bfeaff}
  .fc-meta{font-size:13px;color:rgba(230,238,248,0.6);margin-top:8px}
  .study-controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .q-option{display:block;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);text-align:left;color:#cfefff;cursor:pointer}
  .q-option:hover{background:rgba(255,255,255,0.02);transform:translateY(-3px)}

  /* ===== Right: form ===== */
  label{font-size:13px;color:#e9f6ff;font-weight:700;margin-bottom:6px}
  input,textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:#dff4ff}
  textarea{min-height:76px;resize:vertical}
  .subpanel{margin-top:10px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0))}
  .mini-list{display:flex;flex-direction:column;gap:8px;max-height:180px;overflow:auto;padding-right:6px}
  .mini-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .muted{color:rgba(230,238,248,0.55);font-size:13px}

  /* toast & modal */
  .toast{position:fixed;right:20px;bottom:20px;background:linear-gradient(90deg,#00d4ff,#00aaff);color:#021222;padding:12px 16px;border-radius:10px;box-shadow:0 12px 40px rgba(0,80,150,0.2);display:none;z-index:999}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;display:none}
  .modal .mcard{background:#071025;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:360px}
  .muted-small{font-size:12px;color:rgba(230,238,248,0.55)}
  footer{padding:12px;text-align:center;color:rgba(230,238,248,0.35);font-size:13px}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo" aria-hidden>
      <!-- modern book/library SVG logo -->
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
        <rect x="2" y="3" width="20" height="14" rx="2" fill="white" opacity="0.06"/>
        <path d="M6 7h12" stroke="white" stroke-opacity="0.2" stroke-width="1.2"/>
        <path d="M7 17v-8h5v8" stroke="white" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 17v-8h5v8" stroke="white" stroke-opacity="0.9" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div>
      <h1>pocket-classroom</h1>
      <p class="muted">Offline • Flashcards • Quizzes • Export/Import</p>
    </div>
  </div>

  <div class="top-actions">
    <button id="new-capsule" class="btn small">New Capsule</button>
    <button id="export-all" class="btn small">Export</button>
    <button id="download-sample" class="btn small ghost">Download Sample JSON</button>
    <button id="import-all" class="btn small ghost">Import</button>
    <input id="file-import" type="file" accept=".json" style="display:none" />
  </div>
</header>

<main>
  <!-- Left -->
  <section class="left-col panel">
    <h2>Library</h2>
    <div class="muted" style="margin-bottom:10px">5 sample capsules included — edit or create your own.</div>
    <div id="capsule-list" class="capsule-list"></div>
  </section>

  <!-- Center -->
  <section class="center-col panel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div>
        <h2>Study Mode</h2>
        <div class="muted-small">Select a capsule and press Start — or press Enter.</div>
      </div>
    </div>

    <div class="controls-row" style="margin-top:12px">
      <select id="study-capsule-select"><option value="">— Select capsule —</option></select>
      <button id="start-study" class="btn small">Start</button>
      <button id="shuffle-study" class="btn small ghost">Shuffle</button>

      <div class="progress-wrap" style="margin-left:auto">
        <div id="study-progress" class="muted-small">0/0</div>
        <div class="progress-bar"><i id="progress-fill"></i></div>
      </div>
    </div>

    <div class="study-area">
      <div id="flashcard-study" class="card-large" style="display:none">
        <div class="fc-front" id="fc-front-display">Front</div>
        <div class="fc-back" id="fc-back-display" style="display:none">Back</div>
        <div class="fc-meta" id="fc-meta"></div>
        <div class="study-controls">
          <button id="show-answer" class="btn small">Show Answer</button>
          <button id="mark-learned" class="btn small">Mark Learned</button>
          <button id="next-card" class="btn small ghost">Next</button>
        </div>
      </div>

      <div id="quiz-study" class="card-large" style="display:none">
        <div id="q-text-display" style="font-weight:800;font-size:18px;margin-bottom:14px">Question</div>
        <div id="q-options" style="display:flex;flex-direction:column;gap:10px"></div>
        <div id="q-feedback" class="muted-small" style="margin-top:10px;font-weight:700"></div>
        <div style="margin-top:12px"><button id="q-next" class="btn small">Next</button></div>
      </div>
    </div>
  </section>

  <!-- Right -->
  <aside class="right-col panel">
    <h2>Create / Edit Capsule</h2>
    <div class="muted-small" style="margin-bottom:10px">Title, tags, choose type, add flashcards or quiz questions, then Save.</div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <div><label for="capsule-title">Title</label><input id="capsule-title" type="text" placeholder="e.g. Basic Math" /></div>
      <div><label for="capsule-tags">Tags</label><input id="capsule-tags" type="text" placeholder="e.g. math,algebra" /></div>
      <div><label for="capsule-type">Type</label>
        <select id="capsule-type">
          <option value="note">Note</option>
          <option value="flashcards">Flashcards</option>
          <option value="quiz">Quiz</option>
        </select>
      </div>
      <div><label for="capsule-content">Content</label><textarea id="capsule-content" placeholder="Optional short description..."></textarea></div>
    </div>

    <div id="flashcards-wrapper" class="subpanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:#e6f6ff">Flashcards</strong>
        <div class="muted-small">Add front/back pairs</div>
      </div>
      <div style="margin-top:10px" class="mini-list" id="flashcards-list"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="fc-front" type="text" placeholder="Front" />
        <input id="fc-back" type="text" placeholder="Back" />
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="add-flashcard" class="btn small">Add</button>
        <button id="clear-flashcards" class="btn small ghost">Clear</button>
      </div>
    </div>

    <div id="quiz-wrapper" class="subpanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:#e6f6ff">Quiz</strong>
        <div class="muted-small">Multiple choice (MCQ)</div>
      </div>
      <div style="margin-top:10px" class="mini-list" id="quiz-list"></div>

      <input id="q-text" type="text" placeholder="Question" style="margin-top:8px" />
      <input id="q-opt1" type="text" placeholder="Option 1" />
      <input id="q-opt2" type="text" placeholder="Option 2" />
      <input id="q-opt3" type="text" placeholder="Option 3" />
      <input id="q-opt4" type="text" placeholder="Option 4" />
      <input id="q-correct" type="number" placeholder="Correct (1-4)" min="1" max="4" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="add-quiz" class="btn small">Add</button>
        <button id="clear-quiz" class="btn small ghost">Clear</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="save-capsule" class="btn">Save Capsule</button>
      <button id="cancel-edit" class="btn ghost">Cancel</button>
    </div>
  </aside>
</main>

<footer>pocket-classroom • Offline • Data saved locally in your browser</footer>

<div id="toast" class="toast"></div>
<div id="confirm-modal" class="modal"><div class="mcard"><div id="modal-text" class="muted-small"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="modal-cancel" class="btn small ghost">Cancel</button><button id="modal-accept" class="btn small">OK</button></div></div></div>

<script type="module">
/* ===== final pocket-classroom (Modern) ===== */
const LS_KEY = 'pocket_classroom_final_v1';
let capsules=[], tempFlashcards=[], tempQuiz=[], editingIndex=null;
let studyCards=[], currentStudyIndex=0, studyMode='';

// DOM helper
const $ = id => document.getElementById(id);
const toast = (msg, t=1800) => { const el = $('toast'); el.textContent = msg; el.style.display='block'; el.style.opacity='1'; setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity='0'; setTimeout(()=>el.style.display='none',400); }, t); };

// sample data (already realistic)
function sample() {
  return [
    { title:"Basic Math", tags:"math,arithmetic", type:"flashcards", content:"Simple arithmetic", flashcards:[
        {front:"2 + 2", back:"4"}, {front:"5 − 3", back:"2"}, {front:"3 × 3", back:"9"}, {front:"8 ÷ 2", back:"4"}, {front:"2³", back:"8"}
      ], quiz:[] },
    { title:"Basic Science", tags:"science,physics", type:"quiz", content:"Quick MCQs", flashcards:[], quiz:[
        {text:"Earth gravity approx?", options:["10 N","9.8 m/s²","100 kg","5 m/s²"], correct:2},
        {text:"Atmosphere mainly?", options:["Air","Water","Soil","Rock"], correct:1},
        {text:"Speed of light?", options:["3×10^8 m/s","5×10^8","10^3","1500 m/s"], correct:1}
      ] },
    { title:"English Basics", tags:"english,vocab", type:"flashcards", content:"Common phrases", flashcards:[
        {front:"Hello", back:"سلام"}, {front:"Thank you", back:"متشکرم"}, {front:"Please", back:"لطفاً"}, {front:"Good morning", back:"صبح بخیر"}, {front:"Good night", back:"شب بخیر"}
      ], quiz:[] },
    { title:"World History", tags:"history", type:"quiz", content:"Short facts", flashcards:[], quiz:[
        {text:"Who wrote the Declaration of Independence?", options:["George Washington","Thomas Jefferson","Abraham Lincoln","Benjamin Franklin"], correct:2},
        {text:"WWII began in?", options:["1939","1914","1945","1920"], correct:1}
      ] },
    { title:"Biology Essentials", tags:"biology", type:"flashcards", content:"Key facts", flashcards:[
        {front:"Largest human organ", back:"Skin"}, {front:"Basic unit of life", back:"Cell"}, {front:"Powerhouse of cell", back:"Mitochondria"}, {front:"Genetic material", back:"DNA"}, {front:"Primary lung function", back:"Gas exchange"}
      ], quiz:[] }
  ];
}

// load/save
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw){ capsules = sample(); save(); } else {
    try{ capsules = JSON.parse(raw); if(!Array.isArray(capsules)) throw 'bad'; }catch(e){ capsules = sample(); save(); }
  }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(capsules)); }

// render library
function renderLibrary(){
  const list = $('capsule-list'); list.innerHTML=''; const select = $('study-capsule-select'); select.innerHTML = `<option value="">— Select capsule —</option>`;
  capsules.forEach((c,i)=>{
    const card = document.createElement('div'); card.className='capsule-card';
    const info = document.createElement('div'); info.style.display='flex'; info.style.flexDirection='column';
    const t = document.createElement('div'); t.className='capsule-title'; t.textContent = c.title;
    const m = document.createElement('div'); m.className='capsule-meta'; m.textContent = `${c.type} • ${c.tags || '—'}`;
    info.appendChild(t); info.appendChild(m);

    const actions = document.createElement('div'); actions.className='card-actions';
    const open = document.createElement('button'); open.className='btn small'; open.textContent='Study'; open.addEventListener('click', ()=>{ $('study-capsule-select').value = i; startStudy(); });
    const edit = document.createElement('button'); edit.className='icon'; edit.textContent='✏️'; edit.title='Edit'; edit.addEventListener('click', ()=> openForEdit(i));
    const del = document.createElement('button'); del.className='icon'; del.textContent='🗑️'; del.title='Delete'; del.addEventListener('click', ()=> confirmAction(`Delete "${c.title}"?`, ()=>{ capsules.splice(i,1); save(); renderLibrary(); toast('Deleted'); }));
    actions.appendChild(open); actions.appendChild(edit); actions.appendChild(del);

    card.appendChild(info); card.appendChild(actions); list.appendChild(card);

    const opt = document.createElement('option'); opt.value = i; opt.textContent = c.title; select.appendChild(opt);
  });
}

// open edit
function openForEdit(idx){
  const c = capsules[idx];
  editingIndex = idx;
  $('capsule-title').value = c.title; $('capsule-tags').value = c.tags || ''; $('capsule-type').value = c.type; $('capsule-content').value = c.content || '';
  tempFlashcards = c.flashcards ? [...c.flashcards] : []; tempQuiz = c.quiz ? [...c.quiz] : [];
  renderTempLists();
  $('flashcards-wrapper').style.display = c.type === 'flashcards' ? 'block' : 'none';
  $('quiz-wrapper').style.display = c.type === 'quiz' ? 'block' : 'none';
  window.scrollTo({top:0,behavior:'smooth'});
}

// reset
function resetForm(){ editingIndex = null; tempFlashcards=[]; tempQuiz=[]; $('capsule-title').value=''; $('capsule-tags').value=''; $('capsule-type').value='note'; $('capsule-content').value=''; renderTempLists(); $('flashcards-wrapper').style.display='none'; $('quiz-wrapper').style.display='none'; }

// listeners
$('capsule-type').addEventListener('change', e => { $('flashcards-wrapper').style.display = e.target.value === 'flashcards' ? 'block' : 'none'; $('quiz-wrapper').style.display = e.target.value === 'quiz' ? 'block' : 'none'; });

$('add-flashcard').addEventListener('click', ()=>{
  const f = $('fc-front').value.trim(), b = $('fc-back').value.trim();
  if(!f || !b){ toast('Fill front & back'); return; }
  tempFlashcards.push({front:f,back:b}); $('fc-front').value=''; $('fc-back').value=''; renderTempLists();
});
$('clear-flashcards').addEventListener('click', ()=>{ if(confirm('Clear temporary flashcards?')){ tempFlashcards=[]; renderTempLists(); } });

$('add-quiz').addEventListener('click', ()=>{
  const t=$('q-text').value.trim(); const o1=$('q-opt1').value.trim(); const o2=$('q-opt2').value.trim(); const o3=$('q-opt3').value.trim(); const o4=$('q-opt4').value.trim(); const c=parseInt($('q-correct').value,10);
  if(!t||!o1||!o2||!o3||!o4||![1,2,3,4].includes(c)){ toast('Fill question, 4 options and correct index (1-4)'); return; }
  tempQuiz.push({text:t,options:[o1,o2,o3,o4],correct:c}); $('q-text').value=''; $('q-opt1').value=''; $('q-opt2').value=''; $('q-opt3').value=''; $('q-opt4').value=''; $('q-correct').value=''; renderTempLists();
});
$('clear-quiz').addEventListener('click', ()=>{ if(confirm('Clear temporary quiz questions?')){ tempQuiz=[]; renderTempLists(); } });

function renderTempLists(){
  const fl=$('flashcards-list'); fl.innerHTML=''; tempFlashcards.forEach((f,i)=>{ const row=document.createElement('div'); row.className='mini-item'; const left=document.createElement('div'); left.innerHTML=`<strong>${escapeHtml(f.front)}</strong><div class="muted-small">${escapeHtml(f.back)}</div>`; const right=document.createElement('div'); const del=document.createElement('button'); del.className='btn small ghost'; del.textContent='Remove'; del.addEventListener('click', ()=>{ tempFlashcards.splice(i,1); renderTempLists(); }); right.appendChild(del); row.appendChild(left); row.appendChild(right); fl.appendChild(row); }); if(tempFlashcards.length===0) fl.innerHTML=`<div class="muted-small">No flashcards yet</div>`;

  const ql=$('quiz-list'); ql.innerHTML=''; tempQuiz.forEach((q,i)=>{ const row=document.createElement('div'); row.className='mini-item'; const left=document.createElement('div'); left.innerHTML=`<strong>${escapeHtml(q.text)}</strong><div class="muted-small">${escapeHtml(q.options.join(' • '))}</div>`; const right=document.createElement('div'); const del=document.createElement('button'); del.className='btn small ghost'; del.textContent='Remove'; del.addEventListener('click', ()=>{ tempQuiz.splice(i,1); renderTempLists(); }); right.appendChild(del); row.appendChild(left); row.appendChild(right); ql.appendChild(row); }); if(tempQuiz.length===0) ql.innerHTML=`<div class="muted-small">No questions yet</div>`;
}

// save capsule
$('save-capsule').addEventListener('click', ()=>{
  const title=$('capsule-title').value.trim(); if(!title){ toast('Enter a title'); return; }
  const tags=$('capsule-tags').value.trim(); const type=$('capsule-type').value; const content=$('capsule-content').value.trim();
  const data = {title,tags,type,content, flashcards: type==='flashcards' ? tempFlashcards : [], quiz: type==='quiz' ? tempQuiz : []};
  if(editingIndex === null) capsules.push(data); else capsules[editingIndex] = data;
  save(); renderLibrary(); resetForm(); toast('Saved');
});
$('cancel-edit').addEventListener('click', ()=>{ if(confirm('Cancel editing?')) resetForm(); });
$('new-capsule').addEventListener('click', ()=>{ resetForm(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

// export/import + sample download
$('export-all').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(capsules,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pocket_capsules_export.json'; a.click(); URL.revokeObjectURL(url);
});
$('import-all').addEventListener('click', ()=> $('file-import').click());
$('file-import').addEventListener('change', ev => {
  const file = ev.target.files[0]; if(!file) return;
  const reader = new FileReader(); reader.onload = e => {
    try{
      const data = JSON.parse(e.target.result); if(!Array.isArray(data)) throw 'bad';
      if(!confirm('Import will replace your current library. Continue?')) return;
      capsules = data; save(); renderLibrary(); resetForm(); toast('Imported');
    }catch(err){ toast('Invalid JSON file'); }
  }; reader.readAsText(file);
});
// sample JSON download
$('download-sample').addEventListener('click', ()=>{
  const sampleData = sample(); const blob = new Blob([JSON.stringify(sampleData,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pocket_sample_capsules.json'; a.click(); URL.revokeObjectURL(url);
});

// confirm modal
function confirmAction(text, okcb){
  $('modal-text').textContent = text; $('confirm-modal').style.display = 'flex';
  const ok = $('modal-accept'), cancel = $('modal-cancel');
  const onOk = ()=>{ cleanup(); okcb?.(); };
  const onCancel = ()=> cleanup();
  function cleanup(){ $('confirm-modal').style.display = 'none'; ok.removeEventListener('click', onOk); cancel.removeEventListener('click', onCancel); }
  ok.addEventListener('click', onOk); cancel.addEventListener('click', onCancel);
}

// Study mode
function startStudy(){
  const idx = parseInt($('study-capsule-select').value,10);
  if(Number.isNaN(idx)){ toast('Select a capsule'); return; }
  const capsule = capsules[idx]; currentStudyIndex = 0;
  if(capsule.type === 'flashcards'){
    studyCards = capsule.flashcards ? [...capsule.flashcards] : [];
    if(studyCards.length === 0){ toast('No flashcards here'); return; }
    studyMode = 'flashcards'; $('flashcard-study').style.display='block'; $('quiz-study').style.display='none'; renderFlashcard();
  } else if(capsule.type === 'quiz'){
    studyCards = capsule.quiz ? [...capsule.quiz] : [];
    if(studyCards.length === 0){ toast('No quiz questions'); return; }
    studyMode = 'quiz'; $('flashcard-study').style.display='none'; $('quiz-study').style.display='block'; renderQuizQuestion();
  } else { toast('Capsule has no study content'); return; }
  updateProgress();
}
$('start-study').addEventListener('click', startStudy);
$('study-capsule-select').addEventListener('keydown', (e)=>{ if(e.key==='Enter') startStudy(); });

// shuffle
$('shuffle-study').addEventListener('click', ()=>{ if(!studyCards || studyCards.length===0){ toast('Nothing to shuffle'); return; } studyCards.sort(()=>Math.random()-0.5); currentStudyIndex=0; if(studyMode==='flashcards') renderFlashcard(); else renderQuizQuestion(); toast('Shuffled'); });

// flashcards
function renderFlashcard(){
  if(!studyCards || studyCards.length===0){ $('fc-front-display').textContent='No cards'; $('fc-back-display').style.display='none'; updateProgress(); return; }
  if(currentStudyIndex >= studyCards.length){ toast('Finished'); return; }
  const c = studyCards[currentStudyIndex]; $('fc-front-display').textContent = c.front; $('fc-back-display').textContent = c.back; $('fc-back-display').style.display='none'; $('fc-meta').textContent = `Card ${currentStudyIndex+1} / ${studyCards.length}`; updateProgress();
}
$('show-answer').addEventListener('click', ()=> $('fc-back-display').style.display = 'block');
$('mark-learned').addEventListener('click', ()=>{ if(!studyCards || studyCards.length===0) return; studyCards.splice(currentStudyIndex,1); if(currentStudyIndex >= studyCards.length) currentStudyIndex = 0; renderFlashcard(); });
$('next-card').addEventListener('click', ()=>{ if(!studyCards || studyCards.length===0) return; currentStudyIndex = (currentStudyIndex+1)%studyCards.length; renderFlashcard(); });

// quiz
function renderQuizQuestion(){
  if(!studyCards || studyCards.length===0){ $('q-text-display').textContent='No questions'; $('q-options').innerHTML=''; updateProgress(); return; }
  if(currentStudyIndex >= studyCards.length){ toast('Finished'); return; }
  const q = studyCards[currentStudyIndex]; $('q-text-display').textContent = q.text; $('q-options').innerHTML = ''; $('q-feedback').textContent = '';
  q.options.forEach((opt,i)=>{ const b = document.createElement('button'); b.className='q-option'; b.textContent = opt; b.addEventListener('click', ()=>{ $('q-feedback').textContent = (i+1 === q.correct) ? 'Correct!' : `Wrong — correct: ${q.options[q.correct-1]}`; }); $('q-options').appendChild(b); });
  updateProgress();
}
$('q-next').addEventListener('click', ()=>{ if(!studyCards || studyCards.length===0) return; currentStudyIndex = (currentStudyIndex+1)%studyCards.length; renderQuizQuestion(); });

// progress
function updateProgress(){ const total = (studyCards && studyCards.length) || 0; const cur = Math.min(Math.max(currentStudyIndex+1,0), total); $('study-progress').textContent = total? `${cur}/${total}` : '0/0'; const pct = total ? Math.round((cur / total) * 100) : 0; $('progress-fill').style.width = `${pct}%`; }

// keyboard
document.addEventListener('keydown',(e)=>{ if(e.key===' ' && studyMode==='flashcards'){ e.preventDefault(); const back=$('fc-back-display'); back.style.display = (back.style.display==='none') ? 'block' : 'none'; } if(e.key==='ArrowRight'){ if(studyMode==='flashcards') $('next-card').click(); else if(studyMode==='quiz') $('q-next').click(); } if(e.key==='n'){ $('new-capsule').click(); } });

// helpers
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// init
function init(){ load(); renderLibrary(); renderTempLists(); }
init();

</script>
</body>
</html>
